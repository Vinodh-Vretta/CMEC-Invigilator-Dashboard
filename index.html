<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMEC Invigilation Dashboard - Updated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; }
        .header-bar { background-color: #ffffff; border-bottom: 1px solid #e0e0e0; }
        .main-content { background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 4px; }
        .btn { border-radius: 4px; padding: 8px 16px; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary { background-color: #2c5cc5; color: white; }
        .btn-primary:hover { background-color: #234a9e; }
        .btn-primary:disabled { background-color: #a3b3d6; cursor: not-allowed; }
        .btn-secondary { background-color: #e0e0e0; color: #333; }
        .btn-secondary:hover { background-color: #d1d1d1; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .status-dot.online { background-color: #4caf50; }
        .status-dot.offline { background-color: #d32f2f; }
        .status-dot.disconnected { background-color: #ffc107; }
        .filter-btn { border: 1px solid #ccc; background-color: #f8f9fa; }
        .filter-btn.active { background-color: #2c5cc5; color: white; border-color: #2c5cc5; }
        .actions-menu { display: none; position: absolute; right: 0; top: 100%; margin-top: 4px; background-color: white; border: 1px solid #e0e0e0; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; width: 180px; }
        .actions-menu button { display: block; width: 100%; text-align: left; padding: 8px 12px; font-size: 14px; }
        .actions-menu button:hover { background-color: #f0f2f5; }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Page -->
    <div id="login-page">
        <div class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">CMEC Assessment Invigilation</h2>
                <form id="login-form">
                    <div class="space-y-6">
                        <div>
                            <label for="cmec-id" class="block text-sm font-medium text-gray-700">CMEC ID</label>
                            <input type="text" id="cmec-id" name="cmec-id" value="INVIGILATOR-01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="access-code" class="block text-sm font-medium text-gray-700">Access Code</label>
                            <input type="password" id="access-code" name="access-code" value="PROCTOR-A1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div><button type="submit" class="w-full btn btn-primary py-2">Enter Session</button></div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Dashboard Page (Initially Hidden) -->
    <div id="dashboard-page" class="hidden">
        <header class="header-bar px-6 py-3 flex justify-between items-center">
             <h1 class="text-xl font-medium">Session Dashboard</h1>
            <div class="flex items-center space-x-4">
                <button id="export-csv-btn" class="btn btn-secondary text-sm"><i class="fas fa-file-csv mr-2"></i>Export CSV</button>
                <button id="export-pdf-btn" class="btn btn-secondary text-sm"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button>
                <button id="tech-support-btn" class="text-sm font-medium text-blue-600 hover:underline">Technical Support</button>
            </div>
        </header>

        <main class="p-6">
            <div class="main-content">
                <!-- At a Glance Board -->
                <div class="p-6 border-b border-gray-200">
                     <div class="flex justify-between items-start">
                        <div>
                             <h2 class="text-lg font-medium">Session Status</h2>
                             <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle mr-1"></i>Student names are hidden for privacy. Please use your secure roster to map codes to names.
                             </p>
                        </div>
                        <p id="last-updated-timestamp" class="text-xs text-gray-500 mt-1">Last updated: ...</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4 text-center">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <p class="text-2xl font-bold text-blue-800" id="count-writing">0</p>
                            <p class="text-sm font-medium text-blue-700">Writing</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg border border-red-200">
                            <p class="text-2xl font-bold text-red-800" id="count-absent">0</p>
                            <p class="text-sm font-medium text-red-700">Absent</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300">
                            <p class="text-2xl font-bold text-yellow-800" id="count-makeup">0</p>
                            <p class="text-sm font-medium text-yellow-700">Needs Make-up</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                            <p class="text-2xl font-bold text-purple-800" id="count-issues">0</p>
                            <p class="text-sm font-medium text-purple-700">Flagged Issues</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="filter-controls flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <input type="text" id="search-input" placeholder="Search by CMEC ID" class="px-3 py-2 border border-gray-300 rounded-md w-full sm:w-auto max-w-xs focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <div id="status-filter-group" class="flex items-center space-x-2">
                            <button data-filter="all" class="filter-btn btn btn-sm active">All</button>
                            <button data-filter="Writing" class="filter-btn btn btn-sm">Writing</button>
                            <button data-filter="Absent" class="filter-btn btn btn-sm">Absent</button>
                            <button data-filter="Needs Make-up" class="filter-btn btn btn-sm">Needs Make-up</button>
                        </div>
                    </div>
                    <div class="table-container overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="border-b-2 border-gray-300">
                                <tr>
                                    <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[50%]">CMEC ID</th>
                                    <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[25%]">Status</th>
                                    <th scope="col" class="py-2 px-3 font-medium text-gray-700 w-[25%] text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="student-table-body">
                                <!-- JS Injection -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="action-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-semibold text-gray-800">Action</h2>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="modal-body" class="p-6">
                <!-- Modal content injected by JS -->
            </div>
            <div class="p-4 bg-gray-50 flex justify-end space-x-4 border-t">
                <button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
                <button id="modal-confirm-btn" class="btn btn-primary">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="tech-support-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
         <div class="modal-content bg-white rounded-lg shadow-xl p-8 w-full max-w-lg mx-4">
            <h3 class="text-xl font-medium text-gray-900 mb-4">Information centre hours:</h3>
            <p class="text-lg text-gray-700 mb-6">
                <strong class="font-semibold">Monday to Friday:</strong><br>
                8:00 a.m. to 5:00 p.m. (EST)
            </p>
            <div class="border rounded-md overflow-hidden">
                <table class="w-full">
                    <tbody>
                        <tr class="border-b">
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Email</td>
                            <td class="p-3 text-blue-600 font-medium">bced-support@vretta.com</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-medium bg-gray-50 w-1/3">Phone Number</td>
                            <td class="p-3 font-medium">1-888-887-3882</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-6 text-center">
                <button id="dismiss-support-modal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-md">
                    Dismiss
                </button>
            </div>
        </div>
    </div>
    
    <div id="reentry-password-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-2">Student Re-entry Password</h3>
            <p class="text-sm text-gray-600 mb-4">For Student: <strong id="cmec-id-reentry-modal"></strong></p>
            <p class="text-sm text-gray-700">Provide the following password to the student to re-enter the assessment:</p>
            <div class="my-4 p-3 bg-gray-100 rounded-md border border-gray-300">
                <p id="reentry-password" class="text-2xl font-bold tracking-widest text-gray-800"></p>
            </div>
            <button id="close-reentry-modal" class="btn btn-primary w-full">Close</button>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- MOCK DATA ---
    const sessionStartTime = new Date('2025-09-03T10:00:00-04:00'); // EDT for Toronto
    const initialStudents = [
        { id: '1', cmecId: '123456789', component: 'NME 10', status: 'Writing', connectionStatus: 'online', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '2', cmecId: '987654321', component: 'NME 10', status: 'Enrolled', connectionStatus: 'offline', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '3', cmecId: '456789123', component: 'LTE10', status: 'Writing', connectionStatus: 'online', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '4', cmecId: '789123456', component: 'LTE10', status: 'Writing', connectionStatus: 'disconnected', isFlagged: true, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: { type: 'Glitch', comment: 'Screen froze.', timestamp: new Date('2025-09-03T10:05:00-04:00') }, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T10:05:00-04:00'), action: 'Flagged Issue', details: { type: 'Glitch', comment: 'Screen froze.' }, actor: 'Invigilator'}] },
        { id: '5', cmecId: '321654987', component: 'NME 10', status: 'Enrolled', connectionStatus: 'offline', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '6', cmecId: '234567890', component: 'LTE10', status: 'Absent', connectionStatus: 'offline', isFlagged: false, needsMakeUp: true, absenceDetails: { reason: 'Illness', comment: 'Sent home sick.' }, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T09:55:00-04:00'), action: 'Marked Absent', details: { reason: 'Illness', comment: 'Sent home sick.'}, actor: 'Invigilator'}] },
        { id: '7', cmecId: '345678901', component: 'NME 10', status: 'Writing', connectionStatus: 'online', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: ['Extra Time'], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T10:02:00-04:00'), action: 'Logged Accommodations', details: { used: ['Extra Time']}, actor: 'Invigilator'}] },
        { id: '8', cmecId: '888777666', component: 'NME 10', status: 'Writing', connectionStatus: 'online', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '9', cmecId: '999888777', component: 'LTE10', status: 'Enrolled', connectionStatus: 'offline', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '10', cmecId: '111222333', component: 'NME 10', status: 'Writing', connectionStatus: 'disconnected', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T10:30:00-04:00'), action: 'Student disconnected', actor: 'System'}] },
        { id: '11', cmecId: '222333444', component: 'LTE10', status: 'Absent', connectionStatus: 'offline', isFlagged: false, needsMakeUp: true, absenceDetails: { reason: 'No Show', comment: 'Marked absent by invigilator.' }, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T10:15:00-04:00'), action: 'Marked Absent', details: { reason: 'No Show', comment: 'Marked absent by invigilator.'}, actor: 'Invigilator'}] },
        { id: '12', cmecId: '333444555', component: 'NME 10', status: 'Writing', connectionStatus: 'online', isFlagged: true, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: { type: 'Slow Loading', comment: 'Pages taking long to load.', timestamp: new Date('2025-09-03T10:55:00-04:00')}, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T10:55:00-04:00'), action: 'Flagged Issue', details: { type: 'Slow Loading', comment: 'Pages taking long to load.'}, actor: 'Invigilator'}] },
        { id: '13', cmecId: '444555666', component: 'LTE10', status: 'Writing', connectionStatus: 'online', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: ['Reader', 'Separate Setting'], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }, { timestamp: new Date('2025-09-03T10:03:00-04:00'), action: 'Logged Accommodations', details: { used: ['Reader', 'Separate Setting']}, actor: 'Invigilator'}] },
        { id: '14', cmecId: '555666777', component: 'NME 10', status: 'Enrolled', connectionStatus: 'offline', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] },
        { id: '15', cmecId: '666777888', component: 'LTE10', status: 'Writing', connectionStatus: 'online', isFlagged: false, needsMakeUp: false, absenceDetails: null, accommodations: [], flaggedIssue: null, auditTrail: [{ timestamp: sessionStartTime, action: 'Session Started', actor: 'System' }] }
    ];
    
    let students = JSON.parse(JSON.stringify(initialStudents)); // Deep copy
    let currentFilter = 'all';
    let currentModalAction = null;
    let currentStudentId = null;

    // --- DOM ELEMENTS ---
    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const lastUpdatedTimestamp = document.getElementById('last-updated-timestamp');
    const tableBody = document.getElementById('student-table-body');
    const searchInput = document.getElementById('search-input');
    const statusFilterGroup = document.getElementById('status-filter-group');
    
    // Summary counts
    const countWriting = document.getElementById('count-writing');
    const countAbsent = document.getElementById('count-absent');
    const countMakeup = document.getElementById('count-makeup');
    const countIssues = document.getElementById('count-issues');

    // Modals
    const actionModal = document.getElementById('action-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');

    const techSupportBtn = document.getElementById('tech-support-btn');
    const techSupportModal = document.getElementById('tech-support-modal');
    const dismissSupportModalBtn = document.getElementById('dismiss-support-modal');

    const reentryPasswordModal = document.getElementById('reentry-password-modal');
    const cmecIdReentryModal = document.getElementById('cmec-id-reentry-modal');
    const reentryPassword = document.getElementById('reentry-password');
    const closeReentryModalBtn = document.getElementById('close-reentry-modal');

    // --- UTILITY FUNCTIONS ---
    const logAuditEvent = (studentId, action, details = {}) => {
        const student = students.find(s => s.id === studentId);
        if (student) {
            student.auditTrail.push({
                timestamp: new Date('2025-09-03T11:04:00-04:00'), // Use static current time
                action,
                details,
                actor: 'Invigilator'
            });
        }
    };

    const formatTimestamp = (date) => new Date(date).toLocaleString('en-US', { timeZone: 'America/Toronto', dateStyle: 'short', timeStyle: 'short' });

    // --- RENDER FUNCTIONS ---
    function updateSummaryCounts() {
        countWriting.textContent = students.filter(s => s.status === 'Writing').length;
        countAbsent.textContent = students.filter(s => s.status === 'Absent').length;
        countMakeup.textContent = students.filter(s => s.needsMakeUp).length;
        countIssues.textContent = students.filter(s => s.isFlagged).length;
    }

    function renderTable(studentData) {
        tableBody.innerHTML = '';
        lastUpdatedTimestamp.textContent = `Last updated: 11:04:00 AM`;

        if (studentData.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-500">No students found for this filter.</td></tr>`;
            return;
        }

        studentData.forEach(student => {
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            row.dataset.studentId = student.id;

            let connectionIndicator = '';
            if (student.status === 'Writing') {
                const statusClass = student.connectionStatus;
                connectionIndicator = `<span class="status-dot ${statusClass}" title="${statusClass.charAt(0).toUpperCase() + statusClass.slice(1)}"></span>`;
            }

            let statusColor = 'text-gray-700';
            if(student.status === 'Absent') statusColor = 'text-red-700';
            if(student.status === 'Writing') statusColor = 'text-blue-700';
            
            row.innerHTML = `
                <td class="py-3 px-3">
                    <div class="font-medium text-gray-800">${student.cmecId}</div>
                </td>
                <td class="py-3 px-3">
                    <div class="flex items-center">
                        ${connectionIndicator}
                        <span class="font-medium ${statusColor}">${student.status}</span>
                        ${student.isFlagged ? '<i class="fas fa-flag text-purple-600 ml-2" title="Issue Flagged"></i>' : ''}
                        ${student.needsMakeUp ? '<i class="fas fa-calendar-alt text-yellow-600 ml-2" title="Make-up Needed"></i>' : ''}
                    </div>
                </td>
                <td class="py-3 px-3 text-right">
                    <div class="relative inline-block">
                        <button class="action-btn btn btn-secondary text-xs py-1 px-3 flex items-center" data-student-id="${student.id}">
                            Actions
                            <i class="fas fa-chevron-down ml-2 text-xs opacity-75"></i>
                        </button>
                        <div class="actions-menu">
                            <button class="action-menu-item" data-action="mark-absent">Mark Absent</button>
                            <button class="action-menu-item" data-action="schedule-makeup">Schedule Make-up</button>
                            <button class="action-menu-item" data-action="flag-issue">Flag Issue</button>
                            <button class="action-menu-item" data-action="log-accommodations">Log Accommodations</button>
                            <hr class="my-1">
                            <button class="action-menu-item" data-action="view-details">View Details / Audit</button>
                        </div>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updateView() {
        let displayedStudents = [...students];
        
        // Filter
        if (currentFilter !== 'all') {
             if (currentFilter === 'Needs Make-up') {
                displayedStudents = displayedStudents.filter(s => s.needsMakeUp);
            } else {
                displayedStudents = displayedStudents.filter(s => s.status === currentFilter);
            }
        }
        
        // Search
        const searchTerm = searchInput.value.toLowerCase();
        if (searchTerm) {
            displayedStudents = displayedStudents.filter(student => 
                student.cmecId.toLowerCase().includes(searchTerm)
            );
        }

        renderTable(displayedStudents);
        updateSummaryCounts();
    }

    // --- MODAL & ACTION LOGIC ---

    function openModal(action, studentId) {
        currentModalAction = action;
        currentStudentId = studentId;
        const student = students.find(s => s.id === studentId);
        if (!student) return;

        let title = '';
        let bodyHtml = '';
        
        switch (action) {
            case 'mark-absent':
                title = `Mark Absent: ${student.cmecId}`;
                bodyHtml = `
                    <div class="space-y-4">
                        <div>
                            <label for="absence-reason" class="block text-sm font-medium text-gray-700">Reason for Absence</label>
                            <select id="absence-reason" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                                <option value="Illness">Illness</option>
                                <option value="Technical Issue">Technical Issue</option>
                                <option value="No Show">No Show</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="absence-comment" class="block text-sm font-medium text-gray-700">Optional Comment</label>
                            <textarea id="absence-comment" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                    </div>
                `;
                break;
            case 'schedule-makeup':
                title = `Schedule Make-up: ${student.cmecId}`;
                bodyHtml = `
                    <p class="text-sm mb-4">Select a date and time for the make-up session.</p>
                    <input type="datetime-local" id="makeup-datetime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                `;
                break;
            case 'flag-issue':
                title = `Flag Issue: ${student.cmecId}`;
                bodyHtml = `
                     <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Issue Type</label>
                            <select id="issue-type" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                                <option value="Slow Loading">Slow Loading</option>
                                <option value="Glitch">Glitch / Frozen Screen</option>
                                <option value="Login Problem">Login Problem</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="issue-comment" class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="issue-comment" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                    </div>
                `;
                break;
            case 'log-accommodations':
                 title = `Log Accommodations: ${student.cmecId}`;
                 const accommodationsList = ['Extra Time', 'Scribe', 'Reader', 'Separate Setting'];
                 bodyHtml = accommodationsList.map(acc => `
                    <div class="flex items-center">
                      <input id="acc-${acc.replace(/\s/g, '')}" type="checkbox" ${student.accommodations.includes(acc) ? 'checked' : ''} value="${acc}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                      <label for="acc-${acc.replace(/\s/g, '')}" class="ml-3 block text-sm text-gray-700">${acc}</label>
                    </div>
                 `).join('');
                 break;
            case 'view-details':
                title = `Details: ${student.cmecId}`;
                let auditHtml = student.auditTrail.map(log => `
                    <li class="border-l-2 pl-4 pb-4">
                        <p class="font-medium text-sm">${log.action} <span class="text-gray-500 font-normal">by ${log.actor}</span></p>
                        <p class="text-xs text-gray-500">${formatTimestamp(log.timestamp)}</p>
                        ${log.details && Object.keys(log.details).length > 0 ? `<p class="text-xs text-gray-600 mt-1 bg-gray-100 p-1 rounded">Details: ${JSON.stringify(log.details)}</p>` : ''}
                    </li>
                `).reverse().join('');
                bodyHtml = `
                    <h4 class="font-semibold mb-2">Audit Trail</h4>
                    <ul class="space-y-2">${auditHtml}</ul>
                `;
                break;
        }

        modalTitle.textContent = title;
        modalBody.innerHTML = bodyHtml;
        modalConfirmBtn.style.display = (action === 'view-details') ? 'none' : 'block';
        actionModal.classList.remove('hidden');
    }

    function closeModal() {
        actionModal.classList.add('hidden');
        currentModalAction = null;
        currentStudentId = null;
    }

    function handleConfirm() {
        const student = students.find(s => s.id === currentStudentId);
        if (!student) return;

        switch (currentModalAction) {
            case 'mark-absent':
                const reason = document.getElementById('absence-reason').value;
                const comment = document.getElementById('absence-comment').value;
                student.status = 'Absent';
                student.needsMakeUp = true;
                student.absenceDetails = { reason, comment };
                logAuditEvent(currentStudentId, 'Marked Absent', { reason, comment });
                break;
            case 'schedule-makeup':
                const datetime = document.getElementById('makeup-datetime').value;
                student.needsMakeUp = true; // Could also move to a 'Scheduled' state
                logAuditEvent(currentStudentId, 'Scheduled Make-up', { datetime });
                break;
            case 'flag-issue':
                const type = document.getElementById('issue-type').value;
                const issueComment = document.getElementById('issue-comment').value;
                student.isFlagged = true;
                student.flaggedIssue = { type, comment: issueComment, timestamp: new Date() };
                logAuditEvent(currentStudentId, 'Flagged Issue', { type, comment: issueComment });
                break;
            case 'log-accommodations':
                 student.accommodations = [];
                 document.querySelectorAll('#modal-body input[type="checkbox"]:checked').forEach(cb => {
                    student.accommodations.push(cb.value);
                 });
                 logAuditEvent(currentStudentId, 'Logged Accommodations', { used: student.accommodations });
                 break;
        }

        closeModal();
        updateView();
    }
    
    function openReentryPasswordModal(studentId) {
        const student = students.find(s => s.id === studentId);
        if (!student) return;
        const password = Math.random().toString(36).substring(2, 8).toUpperCase();
        cmecIdReentryModal.textContent = student.cmecId;
        reentryPassword.textContent = password;
        reentryPasswordModal.dataset.studentId = studentId;
        reentryPasswordModal.classList.remove('hidden');
    }

    function closeReentryPasswordModal() {
        const studentId = reentryPasswordModal.dataset.studentId;
        const student = students.find(s => s.id === studentId);
        if (student) {
            student.connectionStatus = 'online';
            logAuditEvent(studentId, 'Re-entry password issued');
        }
        reentryPasswordModal.classList.add('hidden');
        updateView();
    }

    // --- EVENT LISTENERS ---
    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        updateView();
    });
    
    searchInput.addEventListener('input', updateView);

    statusFilterGroup.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentFilter = e.target.dataset.filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            updateView();
        }
    });

    tableBody.addEventListener('click', (e) => {
        const actionBtn = e.target.closest('.action-btn');
        const menuItem = e.target.closest('.action-menu-item');
        const studentRow = e.target.closest('tr');

        // Close all other action menus
        document.querySelectorAll('.actions-menu').forEach(menu => {
            if (!actionBtn || menu !== actionBtn.nextElementSibling) {
                menu.style.display = 'none';
            }
        });

        if (actionBtn) {
            e.stopPropagation();
            const menu = actionBtn.nextElementSibling;
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        } else if (menuItem) {
            e.stopPropagation();
            const studentId = menuItem.closest('td').querySelector('.action-btn').dataset.studentId;
            const action = menuItem.dataset.action;
            openModal(action, studentId);
            menuItem.parentElement.style.display = 'none';
        } else if (studentRow) {
             const studentId = studentRow.dataset.studentId;
             const student = students.find(s => s.id === studentId);
             if (student && student.connectionStatus === 'disconnected') {
                 openReentryPasswordModal(studentId);
             } else {
                 openModal('view-details', studentId);
             }
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.action-btn')) {
            document.querySelectorAll('.actions-menu').forEach(menu => menu.style.display = 'none');
        }
    });

    modalConfirmBtn.addEventListener('click', handleConfirm);
    closeModalBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);

    techSupportBtn.addEventListener('click', () => techSupportModal.classList.remove('hidden'));
    dismissSupportModalBtn.addEventListener('click', () => techSupportModal.classList.add('hidden'));
    closeReentryModalBtn.addEventListener('click', closeReentryPasswordModal);
    
    document.getElementById('export-csv-btn').addEventListener('click', () => alert('Generating session report as CSV...'));
    document.getElementById('export-pdf-btn').addEventListener('click', () => alert('Generating session report as PDF...'));

});
</script>

</body>
</html>


